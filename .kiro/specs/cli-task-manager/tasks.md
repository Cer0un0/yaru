# Implementation Plan

## Task 1: プロジェクト初期設定
- [x] 1.1 Node.js/TypeScriptプロジェクトを初期化する
  - package.jsonを作成し、プロジェクト名・バージョン・エントリポイントを設定する
  - TypeScript設定ファイルを作成し、ESM対応・strict modeを有効化する
  - 必要な開発依存関係（typescript、ts-node、vitest等）をインストールする
  - ソースディレクトリ構造を作成する（src/、src/domain/、src/infrastructure/、src/cli/）
  - _Requirements: 8.1_

- [x] 1.2 (P) 共通型定義とユーティリティを実装する
  - Result型（成功/失敗を表現する判別共用体）を定義する
  - タスクに関する基本型（TaskId、TaskStatus、Priority、Task）を定義する
  - 日時処理やUUID生成のユーティリティ関数を作成する
  - _Requirements: 4.1_

## Task 2: データ永続化レイヤー
- [x] 2.1 ストレージサービスを実装する
  - データ保存用のディレクトリ（~/.task-tools/）を自動作成する機能を実装する
  - JSONファイルからタスクデータを読み込む機能を実装する
  - タスクデータをJSONファイルに保存する機能を実装する
  - アトミック書き込み（一時ファイル経由でのrename）を実装する
  - ファイルが存在しない場合は空のストアを自動作成する
  - データ破損時のエラーハンドリングを実装する
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 2.2 (P) バックアップと復元機能を実装する
  - 保存時にバックアップファイルを作成する機能を実装する
  - 破損時にバックアップからの復元を試みる機能を実装する
  - _Requirements: 6.5_

## Task 3: タスクサービス（ドメインロジック）
- [x] 3.1 タスク作成機能を実装する
  - 一意のタスクIDを生成してタスクを作成する機能を実装する
  - タイトル、説明、優先度を受け取りタスクを初期化する
  - タイトルが空の場合はバリデーションエラーを返す
  - 作成日時と更新日時を自動設定する
  - 初期ステータスをpendingに設定する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 3.2 タスク一覧・検索機能を実装する
  - すべてのタスクを取得する機能を実装する
  - ステータスや優先度でフィルタリングする機能を実装する
  - 優先度や日時でソートする機能を実装する
  - タスクが存在しない場合は空の配列を返す
  - キーワードでタイトルと説明を検索する機能を実装する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 9.1, 9.2, 9.3_

- [x] 3.3 タスク更新・削除機能を実装する
  - IDを指定してタスクの内容を更新する機能を実装する
  - タイトル、説明、優先度の個別更新をサポートする
  - 存在しないIDの場合はNOT_FOUNDエラーを返す
  - IDを指定してタスクを削除する機能を実装する
  - 更新日時を自動更新する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 5.1, 5.2, 5.3_

- [x] 3.4 ステータス管理機能を実装する
  - タスクのステータスを変更する機能を実装する
  - pending、in_progress、completedの3状態をサポートする
  - in_progressへの遷移時に開始日時を記録する
  - completedへの遷移時に完了日時を記録する
  - 無効なステータスの場合はINVALID_STATUSエラーを返す
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

## Task 4: IPC通信レイヤー
- [x] 4.1 IPCプロトコルを実装する
  - リクエスト/レスポンスのメッセージ形式を定義する
  - タスク操作用のメソッド（create、list、get、update、delete、search）を定義する
  - デーモン制御用のメソッド（status、stop）を定義する
  - エラーレスポンスの形式を定義する
  - _Requirements: 7.2_

- [x] 4.2 IPCサーバーを実装する
  - Unix Domain Socket（macOS/Linux）でリッスンする機能を実装する
  - クライアントからのリクエストを受信して処理する機能を実装する
  - レスポンスをクライアントに送信する機能を実装する
  - 接続のタイムアウト処理を実装する
  - ソケットファイルのクリーンアップ処理を実装する
  - _Requirements: 7.2_

- [x] 4.3 (P) IPCクライアントを実装する
  - デーモンのソケットに接続する機能を実装する
  - リクエストを送信してレスポンスを受信する機能を実装する
  - 接続失敗時のエラーハンドリングを実装する
  - タイムアウト処理を実装する
  - _Requirements: 7.5, 10.2_

## Task 5: デーモンプロセス管理
- [x] 5.1 デーモンプロセスのライフサイクルを実装する
  - バックグラウンドプロセスとしてデーモンを起動する機能を実装する
  - PIDファイルでプロセス状態を管理する機能を実装する
  - 起動時にデータを読み込み、IPCサーバーを開始する
  - SIGTERMを受信してグレースフルシャットダウンする機能を実装する
  - _Requirements: 7.1, 7.3_

- [x] 5.2 デーモン状態確認機能を実装する
  - PIDファイルからデーモンの稼働状態を確認する機能を実装する
  - 既存プロセスへの接続判定を実装する
  - プロセスが存在しない場合のPIDファイルクリーンアップを実装する
  - _Requirements: 7.4, 7.5_

## Task 6: CLIインターフェース
- [x] 6.1 CLIフレームワークをセットアップする
  - Commander.jsを使用してメインコマンドを構成する
  - ヘルプオプション（--help）を設定する
  - バージョンオプション（--version）を設定する
  - 不正なコマンド時のエラーメッセージを設定する
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [x] 6.2 デーモン制御コマンドを実装する
  - startコマンド：デーモンを起動する
  - stopコマンド：デーモンを停止する
  - statusコマンド：デーモンの状態を表示する
  - 各コマンドの結果メッセージを実装する
  - _Requirements: 7.1, 7.3, 7.4, 8.5_

- [x] 6.3 タスク操作コマンドを実装する
  - addコマンド：タスクを作成する（--description、--priorityオプション付き）
  - listコマンド：タスク一覧を表示する（--status、--sortオプション付き）
  - showコマンド：タスク詳細を表示する
  - updateコマンド：タスクを更新する
  - doneコマンド：タスクを完了にする
  - deleteコマンド：タスクを削除する
  - searchコマンド：タスクを検索する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4, 4.2, 5.1, 9.1_

- [x] 6.4 出力フォーマットとエラー表示を実装する
  - タスク一覧をテーブル形式で表示する機能を実装する
  - タスク詳細を整形して表示する機能を実装する
  - 操作成功時のメッセージを実装する
  - エラーメッセージを具体的に表示する機能を実装する
  - 適切な終了コードを返す機能を実装する
  - _Requirements: 8.5, 10.1, 10.2, 10.3_

## Task 7: システム統合とテスト
- [x] 7.1 デーモンとCLIを統合する
  - CLIコマンドからIPCクライアント経由でデーモンと通信する
  - リクエストハンドラーでタスクサービスを呼び出す
  - エラーをCLI側で適切に表示する
  - _Requirements: 7.2, 7.5, 10.1, 10.2_

- [x] 7.2 単体テストを実装する
  - タスクサービスのCRUD操作をテストする
  - ストレージサービスのファイル操作をテストする
  - バリデーションロジックをテストする
  - ステータス遷移ロジックをテストする
  - _Requirements: 1.1, 1.5, 3.5, 4.5, 5.3_

- [x] 7.3 統合テストを実装する
  - IPC通信のリクエスト/レスポンスをテストする
  - デーモンのライフサイクル（起動→操作→停止）をテストする
  - CLIコマンドのエンドツーエンド動作をテストする
  - エラーケース（デーモン未起動、存在しないタスク等）をテストする
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 10.1, 10.2, 10.3_

## Task 8: ビルドと配布設定
- [x] 8.1 ビルド設定を完了する
  - TypeScriptのビルド設定を最終化する
  - 実行可能ファイルのエントリポイントを設定する
  - package.jsonのbinフィールドを設定する
  - npm linkでローカルテストできるようにする
  - _Requirements: 8.1_
